<!DOCTYPE html>
<html>
<head>
    <title>Change Password</title>
    <link rel="stylesheet" type="text/css" href="../static/password_change.css">
    <style>
        .message {
            color: red;
            font-weight: bold;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>Change Password</h1>
    <form action="/student_password_change" method="POST" id="password-form">
        <label for="email">Email:</label>
        <input type="email" name="email" value="{{ email }}" required>
        <br>
        <label for="new_password">New Password:</label>
        <input type="password" name="new_password" required>
        <br>
        <label for="confirm_password">Confirm Password:</label>
        <input type="password" name="confirm_password" required>
        <br>
        <label for="Submit">Submit:</label>
        <input type="submit" value="Submit" name="Submit">
    </form>

    <div id="message"></div>

    <script>
        var form_password = document.querySelector('#password-form')
    form_password.addEventListener('submit', function(e) {
    e.preventDefault();
    var email = document.querySelector('input[name=email]').value;
    var new_password = document.querySelector('input[name=new_password]').value;
    var confirm_password = document.querySelector('input[name=confirm_password]').value;
    var message = document.querySelector('#message');

    if (!new_password) {
        // Display error message
        var error = document.createElement('div');
        error.textContent = 'Please enter a new password.';
        message.appendChild(error);
        return;
    }

    if (!confirm_password) {
        // Display error message
        var error = document.createElement('div');
        error.textContent = 'Please confirm your password.';
        message.appendChild(error);
        return;
    }

    if (new_password !== confirm_password) {
        // Display error message
        var error = document.createElement('div');
        error.textContent = 'New password and confirm password do not match.';
        message.appendChild(error);
        return;
    }

    // Check if email is a KU domain email
    if (!email.endsWith("@ku.edu.tr") && !email.endsWith("@KU.EDU.TR")) {
        // Display error message
        var error = document.createElement('div');
        error.textContent = 'Please enter a valid KU domain email.';
        message.appendChild(error);
        return;
    }

    fetch('/student_password_change', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            email: email,
            new_password: new_password
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(response.statusText);
        }
        return response.json();
    })
    .then(data => {
        // Render success message only if new password and confirm password fields are filled and match
        if (new_password && confirm_password && new_password === confirm_password) {
            var success = document.createElement('div');
            success.textContent = data.message;
            message.appendChild(success);
            window.location.href = "/password_change_success.html"; 
        } else {
            var error = document.createElement('div');
            error.textContent = 'Please make sure the new password and confirm password fields are filled and match.';
            message.appendChild(error);
        }
    })
    .catch(error => {
        // Display error message
        var errorDiv = document.createElement
        errorDiv.textContent = error.message;
        message.appendChild(errorDiv);
    });
});
